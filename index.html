<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <script type="text/javascript" src="./lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="./lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="./lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="./lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="./lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="./lib/topojson.v2.min.js"></script>

    <style>


    </style>

    <title></title>
</head>


<body>

<select id="colorDropdown"></select>
<select id="tooltipDropdown"></select>

<script>

    var width = 700
    var height = 1400

    var chicagomap = d3.json("big_dataset_final_REV.geojson")

    var svg = d3.select("body").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 " + width + " " + height)
        .classed("svg-content", true);

    var projection = d3.geoMercator()
        .center([0, 41.8781])
        .rotate([87.6298, 0]).scale(45000)

    var path = d3.geoPath().projection(projection);

    var tip = d3.tip()
        .style("position", "absolute")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .html(function ([d, selected_tooltip]) {
            var selected_data = d.properties[selected_tooltip]
            if (Number.isInteger(selected_data)) {
                return selected_tooltip + ": " + selected_data;
            }
            return selected_tooltip + ": " + selected_data + "%";
            ;
        });

    var colorscale = null;


    chicagomap.then(function (chi_map) {

        var selected_color = "Full Census Tract"

        colorscale = d3.scaleQuantile()
            .domain([d3.min(chi_map.features, function (d) {
                return d.properties[selected_color];
            }), d3.max(chi_map.features, function (d) {
                return d.properties[selected_color];
            })])
            .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

        var selected_tooltip = "Full Census Tract"

        var neighborhoods = svg.append("g")

        svg.call(tip)

        var map = neighborhoods.selectAll('path')
            .data(chi_map.features)
            .enter()
            .append('path')
            .attr('d', path)
            .style("fill", d => {
                return colorscale(d.properties[selected_color]);
            })
            .style("stroke-width", 0.3)
            .style("stroke", "white")
            .on('mouseover', function (d) {
                tip.show([d, selected_tooltip]);

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 3);
            })
            .on('mouseout', function (d) {
                tip.hide();

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 0.3);
            });

        var attributes = Object.keys(chi_map.features[0].properties)

        d3.select("#colorDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#tooltipDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#colorDropdown").on("change", function (d) {
            selected_color = d3.select(this).property("value")
            //console.log(selected_color)

            colorscale = d3.scaleQuantile()
                .domain([d3.min(chi_map.features, function (d) {
                    return d.properties[selected_color];
                }), d3.max(chi_map.features, function (d) {
                    return d.properties[selected_color];
                })])
                .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

            map.style("fill", d => {
                return colorscale(d.properties[selected_color]);

            })
        })

        d3.select("#tooltipDropdown").on("change", function (d) {
            selected_tooltip = d3.select(this).property("value")
            //svg.call(tip)
            //console.log(selected_tooltip)
        })

    })

    //TODO: user check -- see what data appears funky on map
    //TODO: fix aspect ratio on map
    //TODO: implement line charts

</script>

<select id="censusDropdown"></select>
<select id="varDropdown"></select>
</script>

</script>

</body>

</html>