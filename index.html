<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <script type="text/javascript" src="./lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="./lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="./lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="./lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="./lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="./lib/topojson.v2.min.js"></script>

    <style>


    </style>

    <title></title>
</head>


<body>

<select id="colorDropdown"></select>
<select id="tooltipDropdown"></select>

<script>

    var width = 700
    var height = 600

    var chicagomap = d3.json("big_dataset_final_REV.geojson") //TODO: consider dataset swap ?

    var svg = d3.select("body").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 " + width + " " + height)
        .classed("svg-content", true);

    var projection = d3.geoMercator()
        .center([0, 41.8781])
        .rotate([87.6298, 0]).scale(45000)

    var path = d3.geoPath().projection(projection);

    var tip = d3.tip()
        .style("position", "absolute")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .html(function ([d, selected_tooltip]) { //TODO: fix this -- only add to PoP variables
            var selected_data = d.properties[selected_tooltip]
            if (Number.isInteger(selected_data)) {
                return selected_tooltip + ": " + selected_data;
            }
            return selected_tooltip + ": " + selected_data + "%";
            ;
        });

    var colorscale = null;


    chicagomap.then(function (chi_map) {

        var selected_color = "Full Census Tract"

        colorscale = d3.scaleQuantile()
            .domain([d3.min(chi_map.features, function (d) {
                return d.properties[selected_color];
            }), d3.max(chi_map.features, function (d) {
                return d.properties[selected_color];
            })])
            .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

        var selected_tooltip = "Full Census Tract"

        var neighborhoods = svg.append("g")

        svg.call(tip)

        var map = neighborhoods.selectAll('path')
            .data(chi_map.features)
            .enter()
            .append('path')
            .attr('d', path)
            .style("fill", d => {
                return colorscale(d.properties[selected_color]);
            })
            .style("stroke-width", 0.3)
            .style("stroke", "white")
            .on('mouseover', function (d) {
                tip.show([d, selected_tooltip]);

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 3);
            })
            .on('mouseout', function (d) {
                tip.hide();

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 0.3);
            });

        var attributes = Object.keys(chi_map.features[0].properties)

        attributes.pop() //removing Gentrification Status from drop-down

        var year_ind = attributes.indexOf('Year') //removing Year from drop-down and shading
        //console.log(year_ind)
        attributes.splice(year_ind, 1)

        d3.select("#colorDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#tooltipDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#colorDropdown").on("change", function (d) {
            selected_color = d3.select(this).property("value")
            //console.log(selected_color)

            colorscale = d3.scaleQuantile()
                .domain([d3.min(chi_map.features, function (d) {
                    return d.properties[selected_color];
                }), d3.max(chi_map.features, function (d) {
                    return d.properties[selected_color];
                })])
                .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

            map.style("fill", d => {
                return colorscale(d.properties[selected_color]);

            })
        })

        d3.select("#tooltipDropdown").on("change", function (d) {
            selected_tooltip = d3.select(this).property("value")
            //svg.call(tip)
            //console.log(selected_tooltip)
        })


    })
</script>

<select id="censusDropdown"></select>
<select id="varDropdown"></select>
<script>

    var margin = {top: 20, right: 30, bottom: 30, left: 40}
    var w = 960
    var h = 500

    var sdoh = d3.csv("sdoh_2009-2019_final.csv")

    var svg2 = d3.select("body")
        .append("svg")
        .attr("id", "svg2")
        .attr("width", w)
        .attr("height", h);

    sdoh.then(data => {
        let censusTracts = Array.from(new Set(data.map(function (d) {
            return d['Census Tract']
        })));
        //console.log(censusTracts)

        let variables = data.columns.slice(3)

        let years = Array.from(new Set(data.map(function (d) {
            return d['Year']
        })));

        //console.log(years)

        d3.select("#censusDropdown")
            .selectAll('attributes')
            .data(censusTracts)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#varDropdown")
            .selectAll('attributes')
            .data(variables)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        var selected_census = '17031010100'

        var selected_var = 'Total Weighted Population'

        var data_subset = data.filter(function (d) {
            return d['Census Tract'] === selected_census
        })
        //console.log(data_subset)

        var selected_years = data_subset.map(d => d['Year'])
        console.log(selected_years)
        var selected_data = data_subset.map(d => d[selected_var])

        //console.log(selected_data)

        d3.select("#censusDropdown").on("change", function (d) {
            selected_census = d3.select(this).property("value")
            //console.log(selected_census)
            data_subset = data.filter(function (d) {
                return d['Census Tract'] === selected_census
            })
            selected_years = data_subset.map(d => d['Year'])
            //console.log(data_subset)
            //console.log(selected_years)
            selected_data = data_subset.map(d => d[selected_var])
            //console.log(selected_data)
        })

        d3.select("#varDropdown").on("change", function (d) {
            selected_var = d3.select(this).property("value")
            //console.log(selected_var)
            data_subset = data.filter(function (d) {
                return d['Census Tract'] === selected_census
            })
            //console.log(data_subset)
            selected_years = data_subset.map(d => d['Year'])
            //console.log(selected_years)
            selected_data = data_subset.map(d => d[selected_var])
            //console.log(selected_data)
        })

        var xScale = d3.scaleTime()
            .domain(years)
            .range([0, w - margin.left - margin.right]);

        var yScale = d3.scaleLinear()
            .domain([d3.min(selected_data), d3.max(selected_data)])
            .range([h - margin.top - margin.bottom, 0]);

        var yaxis = d3.axisLeft()
            .ticks(9)
            .scale(yScale);

        var xaxis = d3.axisBottom()
            .ticks(d3.timeYear.every(1))
            .tickFormat(d3.timeFormat('%Y'))
            .scale(xScale);

        var line = d3.line()
            .x(xScale(selected_years))
            .y(yScale(selected_data));

        var x_axis = svg2.append("g")
            .attr("class", "axis")
            .attr("id", "x-axis-a")
            .attr("transform", `translate(${margin.left + 25}, ${(h - margin.bottom)})`)
            .call(xaxis);

        var y_axis = svg2.append("g")
            .attr("id", "y-axis-a")
            .attr("transform", `translate(${margin.left + 25}, ${(margin.top)})`)
            .call(yaxis);

    })

    //TODO: add labels to drop-downs ?
    //TODO: implement line charts
    //TODO: message Brittany about revised dataset

</script>


</body>

</html>