<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <script type="text/javascript" src="./lib/d3.v5.min.js"></script>
    <script type="text/javascript" src="./lib/d3-dsv.min.js"></script>
    <script type="text/javascript" src="./lib/d3-legend.min.js"></script>
    <script type="text/javascript" src="./lib/d3-tip.min.js"></script>
    <script type="text/javascript" src="./lib/d3-geo-projection.v2.min.js"></script>
    <script type="text/javascript" src="./lib/topojson.v2.min.js"></script>

    <style>


    </style>

    <title></title>
</head>


<body>

<select id="colorDropdown"></select>
<select id="tooltipDropdown"></select>

<script>

    var width = 800
    var height = 600

    var chicagomap = d3.json("big_dataset_final_REV.geojson")

    var svg = d3.select("body").append("svg")
        .attr("preserveAspectRatio", "xMinYMin meet")
        .attr("viewBox", "0 0 " + width + " " + height)
        .classed("svg-content", true);

    var projection = d3.geoMercator()
        .center([0, 41.8781])
        .rotate([87.6298, 0]).scale(45000)

    var path = d3.geoPath().projection(projection);

    var tip = d3.tip()
        .style("position", "absolute")
        .style("background-color", "white")
        .style("border", "solid")
        .style("border-width", "1px")
        .style("border-radius", "5px")
        .style("padding", "10px")
        .html(function ([d, selected_tooltip]) {
            var selected_data = d.properties[selected_tooltip]
            if (selected_tooltip.includes("PoP") || selected_tooltip.includes("PoEP") || selected_tooltip.includes("PoH")
                || selected_tooltip.includes("PHU") || selected_tooltip.includes("POHU") || selected_tooltip.includes("PoW")
                || selected_tooltip.includes("PoF") || selected_tooltip.includes("Percent") || selected_tooltip.includes("Crime")) {
                return selected_tooltip + ": " + selected_data + "%";
            }
            return selected_tooltip + ": " + selected_data;
            ;
        });

    var colorscale = null;


    chicagomap.then(function (chi_map) {

        var selected_color = "Full Census Tract"

        colorscale = d3.scaleQuantile()
            .domain([d3.min(chi_map.features, function (d) {
                return d.properties[selected_color];
            }), d3.max(chi_map.features, function (d) {
                return d.properties[selected_color];
            })])
            .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

        var selected_tooltip = "Full Census Tract"

        var neighborhoods = svg.append("g")

        svg.call(tip)

        var map = neighborhoods.selectAll('path')
            .data(chi_map.features)
            .enter()
            .append('path')
            .attr('d', path)
            .style("fill", d => {
                return colorscale(d.properties[selected_color]);
            })
            .style("stroke-width", 0.3)
            .style("stroke", "white")
            .on('mouseover', function (d) {
                tip.show([d, selected_tooltip]);

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 3);
            })
            .on('mouseout', function (d) {
                tip.hide();

                d3.select(this)
                    .style("opacity", 1)
                    .style("stroke", "white")
                    .style("stroke-width", 0.3);
            });

        var attributes = Object.keys(chi_map.features[0].properties)

        attributes.pop() //removing Gentrification Status from drop-down

        var year_ind = attributes.indexOf('Year') //removing Year from drop-down and shading
        //console.log(year_ind)
        attributes.splice(year_ind, 1)

        d3.select("#colorDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#tooltipDropdown")
            .selectAll('attributes')
            .data(attributes)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#colorDropdown").on("change", function (d) {
            selected_color = d3.select(this).property("value")
            //console.log(selected_color)

            colorscale = d3.scaleQuantile()
                .domain([d3.min(chi_map.features, function (d) {
                    return d.properties[selected_color];
                }), d3.max(chi_map.features, function (d) {
                    return d.properties[selected_color];
                })])
                .range(["#eff3ff", "#c6dbef", "#9ecae1", "#6baed6", "#4292c6", "#2171b5", "#084594"]);

            map.style("fill", d => {
                return colorscale(d.properties[selected_color]);

            })
        })

        d3.select("#tooltipDropdown").on("change", function (d) {
            selected_tooltip = d3.select(this).property("value")
            //svg.call(tip)
            //console.log(selected_tooltip)
        })


    })
</script>

<select id="censusDropdown"></select>
<select id="varDropdown"></select>
<br>
<script>

    var margin = {top: 20, right: 30, bottom: 30, left: 40}
    var w = 960
    var h = 500

    var sdoh = d3.csv("sdoh_2009-2019_final.csv", d3.autoType);
    //console.log(sdoh)

    var svg2 = d3.select("body")
        .append("svg")
        .attr("id", "svg2")
        .attr("width", w)
        .attr("height", h);

    sdoh.then(data => {
        data.forEach(d => {
            d['Year'] = new Date(d['Year'], 0)
        })

        let censusTracts = Array.from(new Set(data.map(function (d) {
            return d['Census Tract']
        })));

        let variables = data.columns.slice(3);

        variables.splice(variables.length - 3, 3);

        var med_ind = variables.indexOf("Medically Underserved Areas")
        variables.splice(med_ind, 1)

        var pri_ind = variables.indexOf("Primary Rural-Urban Commuting Area Code 2000")
        variables.splice(pri_ind, 1)

        var sec_ind = variables.indexOf("Secondary Rural-Urban Commuting Area Code 2010")
        variables.splice(sec_ind, 1)

        var la_ind = variables.indexOf("Land Area in Square Miles")
        variables.splice(la_ind, 1)

        d3.select("#censusDropdown")
            .selectAll('attributes')
            .data(censusTracts)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        d3.select("#varDropdown")
            .selectAll('attributes')
            .data(variables)
            .enter()
            .append('option')
            .text(function (d) {
                return d;
            })
            .attr("value", function (d) {
                return d;
            })

        var census = 17031010100

        var variable = 'Total Weighted Population'

        var filtered_data = data.filter(function (d) {
            return d['Census Tract'] === census
        })

        function create_linechart(selected_census, selected_var, data_subset) { //creation of line chart function
            var xScale = d3.scaleTime()
                .domain([
                    d3.min(data_subset, function (d) {
                        return d['Year'];
                    }),
                    d3.max(data_subset, function (d) {
                        return d['Year'];
                    })
                ])
                .range([0, w - margin.left - margin.right]);

            var yScale = d3.scaleLinear()
                .domain([d3.min(data_subset, function (d) {
                    return d[selected_var];
                }),
                    d3.max(data_subset, function (d) {
                        return d[selected_var];
                    })])
                .range([h - margin.top - margin.bottom, 0]);

            var yaxis = d3.axisLeft()
                .ticks(9)
                .scale(yScale);

            var xaxis = d3.axisBottom()
                .ticks(d3.timeYear.every(1))
                .tickFormat(d3.timeFormat('%Y'))
                .scale(xScale);

            var x_axis = svg2.append("g")
                .attr("class", "x-axis")
                .attr("transform", `translate(${margin.left}, ${(h - margin.bottom)})`)
                .call(xaxis);

            var y_axis = svg2.append("g")
                .attr("class", "y-axis")
                .attr("transform", `translate(${margin.left}, ${(margin.top)})`)
                .call(yaxis);

            var line = svg2.append("path")
                .datum(data_subset)
                .attr("class", "curr-line")
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2.5)
                .attr("transform", `translate(${margin.left}, ${(margin.top)})`)
                .attr("d", d3.line()
                    .x(function (d) {
                        return xScale(d['Year'])
                    })
                    .y(function (d) {
                        return yScale(d[selected_var])
                    })
                )

            var dots = svg2.append("g").attr("id", "circles");

            let circles = dots.selectAll("g.dot")
                .data(data_subset)
                .enter().append("g")
                .attr("class", "circles")
                .attr("fill", "steelblue");

            circles
                .selectAll("circle")
                .data(data_subset)
                .enter().append("circle")
                .attr("r", 4)
                .attr("transform", `translate(${margin.left}, ${(margin.top)})`)
                .attr("cx", function (d, i) {
                    return xScale(d['Year']);
                })
                .attr("cy", function (d, i) {
                    return yScale(d[selected_var]);
                })
                .on("mouseover", mouseover)
                .on("mouseout", mouseout);

            var min_tip = d3.tip()
                .style("position", "absolute")
                .style("background-color", "white")
                .style("border", "solid")
                .style("border-width", "1px")
                .style("border-radius", "5px")
                .style("padding", "10px")
                .html(function ([selected_var, selected_display]) {
                    if (selected_var.includes("PoP") || selected_var.includes("PoEP") || selected_var.includes("PoH")
                        || selected_var.includes("PHU") || selected_var.includes("POHU") || selected_var.includes("PoW")
                        || selected_var.includes("PoF") || selected_var.includes("Percent") || selected_var.includes("Crime")) {
                        return selected_display + "%";
                    }
                    return selected_display;
                    ;
                });

            var selected_display = ""

            svg2.call(min_tip)

            function mouseover(d) {
                //console.log(d3.select(this)._groups[0][0].__data__[selected_var])
                selected_display = d3.select(this)._groups[0][0].__data__[selected_var]
                d3.select(this).attr("r", 9)
                min_tip.show([selected_var, selected_display])
            }

            function mouseout(d) {
                d3.select(this).attr("r", 4)
                min_tip.hide()

            };


        }

        create_linechart(census, variable, filtered_data) //initial creation of line chart

        d3.select("#censusDropdown").on("change", function (d) {
            census = parseInt(d3.select(this).property("value"))
            //console.log(selected_census)
            filtered_data = data.filter(function (d) {
                return d['Census Tract'] === census
            })
            //console.log(data_subset)

            d3.select(".x-axis").remove()
            d3.select(".y-axis").remove()
            d3.select(".curr-line").remove()
            d3.select("#circles").remove()

            create_linechart(census, variable, filtered_data)

        })

        d3.select("#varDropdown").on("change", function (d) {
            variable = d3.select(this).property("value")
            //console.log(selected_var)
            filtered_data = data.filter(function (d) {
                return d['Census Tract'] === census
            })
            //console.log(data_subset)

            d3.select(".x-axis").remove()
            d3.select(".y-axis").remove()
            d3.select(".curr-line").remove()
            d3.select("#circles").remove()

            create_linechart(census, variable, filtered_data)
        })

    })

    //TODO: complete some UX checks: ensure everything works for various drop-downs
    //TODO: message Brittany about revised dataset

</script>


</body>

</html>